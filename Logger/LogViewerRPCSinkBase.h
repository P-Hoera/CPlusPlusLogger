#pragma once

#include "LoggerAPI.h"

#include "SinkBase.h"
#include "ProcessInfo.h"

#pragma warning( push )
#pragma warning( disable : 4251 )

namespace Log
{
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// \brief Base class of all sinks targeting a RPC connection. Must be initialized in order to sink incomming 
	///		   messages. Can be initialized as a dummy in case errors prevent a normal initialization. 
	///        Initialization of any kind should only be delayed as much as possible to prevent high memory consumtion.
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	class LOGGER_API LogViewerRPCSinkBase : public SinkBase
	{
	public:
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/// \brief Destructor.
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		virtual ~LogViewerRPCSinkBase();

	protected:
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/// \brief Constructor.
		///
		/// \param sinkName A name for the sink that can be used to identify it.
		/// \param sinkType The type of the sink.
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		LogViewerRPCSinkBase(const std::string& sinkName, const SinkType sinkType);

		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/// \brief Initializes the sink. Does not do any initialization if the class is already initialized.
		///
		/// \param protocol The protocol to use.
		/// \param networkAddress The network address to use, if the protocol requires it.
		/// \param endpoint The endpoint to use, if its not dynamic or the protocol requires it.
		///
		/// \exception std::runtime_error Thrown if the connection to the server could not be established.
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		void initialize(const std::string& protocol, const std::string& networkAddress, const std::string& endpoint);

		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/// \brief Initializes the sink as dummy. Does not do any initialization if the class is already initialized.
		///		   Initializing as dummy discards all log entries.
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		void initializeAsDummy();

		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/// \brief Writes a stored log entry to the RPC connection. It is only called after initialization or initialization 
		///		   as dummy was successful.
		///
		/// \param logEntry The log entry to be written.
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		virtual void write(const std::shared_ptr<LogEntry> logEntry) final;

	private:
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/// \brief Disconnects the RPC connection.
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
		void disconnectRPC();

		bool m_isConnected = false; //!< Holds if the RPC part is connected to a server.
		void* m_rpcBindingHandle = nullptr; //!< The RPC handle if a connection is established.
		void* m_rpcContextHandle = nullptr; //!< The RPC context handle if a connection is established.
		static const ProcessInfo m_currentProcessInfo; //!< Information of the current process this code runs in.
	};
}

#pragma warning( pop ) 